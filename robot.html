<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Economentor | Robotlar</title>
  <link rel="icon" href="image1.png" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #111;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      padding: 30px;
    }
    .robot-card {
      background: rgba(255, 255, 255, 0.1);
      border-left: 4px solid #4CAF50;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .robot-card h3 {
      margin: 0 0 10px;
      font-size: 22px;
    }
    .robot-card p {
      margin: 0 0 15px;
      white-space: pre-line;
    }
    .buttons {
      display: flex;
      gap: 10px;
    }
    .robot-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }
    .request-btn { background: #3498db; color: white; }
    .request-btn.requested { background: #27ae60; }
    .download-btn { background: #f39c12; color: white; }
  </style>
</head>
<body>
  <div class="container" id="robotList">Yükleniyor...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyADPBpJhZ9UKR1NFC42bqEqgKHyLaWunIQ",
      authDomain: "economentor-8ddc4.firebaseapp.com",
      projectId: "economentor-8ddc4",
      storageBucket: "economentor-8ddc4.appspot.com",
      messagingSenderId: "835370350520",
      appId: "1:835370350520:web:d9bb275eb4d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUser;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        document.getElementById("robotList").innerHTML = "<p>Lütfen giriş yapınız.</p>";
        return;
      }
      currentUser = user;
      await loadRobots(user.uid);
    });

async function loadRobots(userId) {
  const robotList = document.getElementById("robotList");
  robotList.innerHTML = "";

  const q = query(collection(db, "robots"), orderBy("timestamp", "desc"));
  const snapshot = await getDocs(q);

  if (snapshot.empty) {
    robotList.innerHTML = "<p>Henüz yayınlanmış robot bulunmuyor.</p>";
    return;
  }

  const sharedMap = await getUserSharedRobotMap(userId);

  for (const docSnap of snapshot.docs) {
    const r = docSnap.data();
    const robotId = docSnap.id;

    const requestRef = doc(db, "requests", `${userId}_${robotId}`);
    const requestSnap = await getDoc(requestRef);
    const alreadyRequested = requestSnap.exists();

    const isShared = sharedMap[robotId] !== undefined;
    const fileUrl = isShared ? sharedMap[robotId].fileUrl : null;
    const fileDocId = isShared ? sharedMap[robotId].fileDocId : null;

    const div = document.createElement("div");
    div.className = "robot-card";

    let downloadButton = "";
    if (isShared) {
      downloadButton = `<button class="robot-btn download-btn" data-url="${fileUrl}" data-docid="${fileDocId}" data-robot-id="${robotId}">İndir</button>`;
    }

    div.innerHTML = `
      <h3>${r.title}</h3>
      <p>${(r.description || '').replace(/\n/g, "<br>")}</p>
      <div class="buttons">
        ${downloadButton}
        <button class="robot-btn request-btn ${alreadyRequested ? "requested" : ""}"
                data-robot-id="${robotId}">
          ${alreadyRequested ? "Talep Edildi" : "Talep Et"}
        </button>
      </div>
    `;

    robotList.appendChild(div);
  }

  setupRequestListeners(userId);
  setupDownloadListeners(userId);
}


function setupRequestListeners(userId) {
  const buttons = document.querySelectorAll(".request-btn");
  buttons.forEach(btn => {
    btn.addEventListener("click", async () => {
      const robotId = btn.dataset.robotId;
      const requestRef = doc(db, "requests", `${userId}_${robotId}`);
      const requestSnap = await getDoc(requestRef);

      if (requestSnap.exists()) {
        // Talebi iptal et
        await deleteDoc(requestRef);
        btn.classList.remove("requested");
        btn.textContent = "Talep Et";
        alert("Talebiniz iptal edildi.");
      } else {
        // Talebi oluştur
        await setDoc(requestRef, {
          userId,
          robotId,
          requestedAt: Timestamp.now(),
        });
        btn.classList.add("requested");
        btn.textContent = "Talep Edildi";
        alert("Talebiniz alındı. Sizinle en kısa zamanda iletişime geçilecektir.");
      }
    });
  });
}

async function getUserSharedRobotMap(userId) {
  const sharedMap = {};
  const q = query(
    collection(db, "uploadedFiles"),
    where("sharedWith", "array-contains", userId)
  );
  const snap = await getDocs(q);

  snap.forEach(docSnap => {
    const d = docSnap.data();
    if (d.robotId && d.fileUrl) {
      sharedMap[d.robotId] = {
        fileUrl: d.fileUrl,
        fileDocId: docSnap.id
      };
    }
  });

  return sharedMap;
}

function setupDownloadListeners(userId) {
  const downloadButtons = document.querySelectorAll(".download-btn");

  downloadButtons.forEach(btn => {
    btn.addEventListener("click", async () => {
      const isMobile = /Mobi|Android/i.test(navigator.userAgent);
      if (isMobile) {
        alert("Lütfen bu dosyayı bilgisayar üzerinden indirin.");
        return;
      }

      const fileUrl = btn.dataset.url;
      const fileDocId = btn.dataset.docid;
      const robotId = btn.dataset.robotId;

      try {
        // Windows dizinine indirme denemesi
        const anchor = document.createElement("a");
        anchor.href = fileUrl;
        anchor.download = "C:\\iDeal\\ChartSistem\\" + fileUrl.split("/").pop();
        anchor.click();

        // Supabase'den sil
        const filePath = fileUrl.split("/").slice(-1)[0]; // dosya ismi
        await supabase.storage.from("robotlar").remove([filePath]);

        // Firestore'dan sil
        await deleteDoc(doc(db, "uploadedFiles", fileDocId));

        // UI'dan indir butonunu kaldır
        btn.remove();

        alert("Dosya başarıyla indirildi ve paylaşılan bilgiler kaldırıldı.");

      } catch (err) {
        console.error("İndirme sırasında hata:", err);
        alert("Dosya indirilemedi veya silme işlemi başarısız oldu.");
      }
    });
  });
}

  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Economentor | Mesajlar</title>
  <link rel="icon" type="image/png" href="image1.png" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
    body {
      background: url('image1-büyük.png') no-repeat center center fixed;
      background-size: cover;
      animation: gradientShift 15s ease infinite;
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      flex-wrap: wrap;
    }
    .lang-btn {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      background: linear-gradient(to right, #6a11cb, #2575fc);
      color: white;
      font-weight: bold;
      cursor: pointer;
      margin-left: 10px;
    }
    .container {
      display: flex;
      flex: 1;
      overflow: hidden;
      height: calc(100vh - 70px);
    }

.chat-list {
  width: 30%;
  max-width: 250px;
  background: rgba(0, 0, 0, 0.4);
  padding: 20px;
  padding-top: 60px;  /* Arama çubuğunun üstüne gelmesini engellemek için ekstra boşluk */
  overflow-y: auto;
  position: relative;
  height: 93.3vh;
}

    .chat-item {
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      margin-bottom: 10px;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
      position: relative;
    }
    .chat-item.active {
      background: #007bff;
      font-weight: bold;
    }
    .notification {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 10px;
      height: 10px;
      background-color: red;
      border-radius: 50%;
    }
    .last-message {
      font-size: 0.85em;
      color: #ccc;
      margin-top: 5px;
    }
.search-bar {
  margin-bottom: 15px;
  padding: 8px;
  border-radius: 6px;
  width: 80%;  /* Arama çubuğunu genişletiyoruz */
  max-width: 100%;  /* Arama çubuğunun maksimum genişliği */
  border: 1px solid #ddd;
  position: absolute;
  top: 10px;  /* Arama çubuğunu biraz yukarıya yerleştiriyoruz */
  background-color: rgba(0, 0, 0, 0.6);
  z-index: 20;
  margin-top: 0 px;  /* Arama çubuğunun ilk kişiyle birleşmesini engelliyoruz */
  color: white;
}
    
    .chat-window {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      background: rgba(0, 0, 0, 0.2);
      height: calc(105vh - 140px);
    }
.messages {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch; /* Mobilde doğru scroll algısı için */
  margin-bottom: 20px;
  padding-right: 10px;
  display: flex;
  flex-direction: column;
}
    .message {
      padding: 10px;
      margin-bottom: 10px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      max-width: 80%;
      position: relative;
      word-break: break-word;
      overflow-wrap: anywhere;
    }
    .message.you {
      background: rgba(0, 255, 127, 0.3);
      align-self: flex-end;
    }
    .sender-label {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .timestamp {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 5px;
    }
  .send-box {
  position: fixed;
  bottom: 0;
  left: 250px; /* chat list genişliği kadar */
  right: 0;
  padding: 10px;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(6px);
  display: flex;
  gap: 10px;
  z-index: 99;
}
    input[type="text"] {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
    }
button.send-btn,
.home-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 12px;
  background: rgba(0, 123, 255, 0.15); /* Hafif transparan mavi */
  color: #ffffff;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  border: 1px solid rgba(0, 123, 255, 0.4);
}

button.send-btn:hover,
.home-btn:hover {
  background: rgba(0, 123, 255, 0.25);
  box-shadow: 0 6px 18px rgba(0, 123, 255, 0.4);
  transform: translateY(-2px);
}

.lang-btn {
  background-color: rgba(0, 0, 0, 0.8);
  color: #fff;
  font-weight: bold;
  font-size: 16px;
  padding: 10px 20px;
  border-radius: 5px;
  border: none;
  cursor: pointer;
}

.lang-btn:hover {
  background-color: #333;
  color: white;
}
    .mobile-search-wrapper {
  display: none;
}

.last-message {
  font-size: 0.85em;
  color: #ccc;
  margin-top: 5px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

  .scroll-button {
  position: fixed;
  right: 15px;
  z-index: 9999;
  width: 40px;
  height: 40px;
  background-color: rgba(0,0,0,0.7);
  color: white;
  font-size: 22px;
  border-radius: 50%;
  display: flex; /* Burası çok önemli */
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: opacity 0.3s ease;
}
  
.scroll-button.top {
  top: 85px;
  bottom: auto;
  left: 50%;
  transform: translateX(-50%);
  position: absolute;
}

.scroll-button.bottom {
  bottom: 0px;
  top: auto;
  left: 50%;
  transform: translateX(-50%);
  position: absolute;
}

#scrollUpBtn {
  bottom: 100px;
}
#scrollDownBtn {
  bottom: 80px !important; /* istediğin yüksekliğe göre 60, 70, 80... */
}

.seen-status {
  font-size: 0.75em;
  margin-top: 4px;
  text-align: right;
  font-weight: 600;
  opacity: 0.8;
  transition: color 0.3s ease;
}

.seen-status.pending {
  color: #999; /* Gri - Henüz karşı taraf sayfayı açmadı */
}

.seen-status.active {
  color: #1e90ff; /* Koyu asil mavi - Görüldü */
}
    
@media (max-width: 770px) {
  .container {
    flex-direction: column;
  }

  body {
    overflow: hidden !important;
    margin: 0 !important;
    padding: 0 !important;
    height: 100vh;
    max-height: 100vh;
  }

  .search-bar {
    display: none !important;
  }

  .mobile-search-wrapper {
    display: block !important;
    position: sticky;
    top: 0;
    z-index: 99;
    padding: 10px 15px;
    background-color: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
  }

  .chat-list {
    width: 100% !important;
    max-width: none !important;
    height: auto !important;
    padding: 10px !important;
    padding-top: 10px !important;
    box-sizing: border-box;
    overflow: hidden !important; /* container taşmasını engelle */
  }

#chatItems {
  direction: ltr !important;
  text-align: left;
  overflow-x: auto !important;
  overflow-y: hidden !important;
  display: flex;
  flex-direction: row;
  scroll-snap-type: x mandatory;
  padding-bottom: 10px;
  gap: 10px;
  scroll-behavior: smooth;
  overscroll-behavior-x: contain; /* ← scroll dışına çıkmayı engeller */
  padding-left: 0px
  scroll-padding-left: 10px;
}

    #chatItems::-webkit-scrollbar {
    display: none;
  }

  .chat-item {
    flex: 0 0 auto !important;
    min-width: 140px !important;
    max-width: 200px !important;
    scroll-snap-align: start !important;
    background: rgba(255, 255, 255, 0.15) !important;
    border-radius: 6px;
    padding: 10px;
  }

.chat-item:first-child {
  margin-left: 0 !important;
}
  
  .chat-item.active {
    background: rgba(0, 123, 255, 0.5) !important;
    border: 2px solid #ffffff50;
    font-weight: bold;
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.4);
    transform: scale(1.03);
  }

  .messages {
    max-height: calc(100vh - 250px);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  .chat-window {
    width: 100%;
    padding: 0;
    margin-top: 0;
    height: 400px;
    max-height: calc(100vh - 250px);
    overflow-y: auto;
  }

  .send-box {
    flex-direction: column;
    position: sticky;
    bottom: 0;
    z-index: 99;
  }

  .send-box input[type="text"],
  .send-box button.send-btn {
    width: 100%;
  }

  .send-box button.send-btn {
    margin-top: 8px;
  }

  #scrollDownBtn,
  #scrollUpBtn {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
  }

  #scrollDownBtn {
    bottom: 132px !important;
  }

  #scrollUpBtn {
    top: 232px;
  }

  .mobile-search-bar {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 16px;
    color: white;
    background-color: rgba(0, 0, 0, 0.5);
  }

  .chat-start-spacer {
  width: 10px;
  flex-shrink: 0;
  height: 1px;
}
}

/* <button onclick="scrollToBottom()" style="position:fixed;top:10px;right:10px;z-index:999;">Scroll Test</button> */
  </style>
</head>
<body>
  <header>
    <h2 id="pageTitle">Mesajlar</h2>
    <div>
      <button class="home-btn" onclick="goHome()" id="homeBtn">Ana Sayfa</button>
    </div>
  </header>
  <div class="mobile-search-wrapper">
  <input type="text" class="mobile-search-bar" id="mobileSearchBar" placeholder="Kişi ara..." oninput="filterChatList()">
  </div>
<div class="container">
  <div class="chat-list" id="chatList">
  <input type="text" class="search-bar" id="searchBar" placeholder="Kişi ara..." oninput="filterChatList()">
  <div id="chatItems">Yükleniyor...</div>
  </div>
  <div class="chat-window">
    <div class="messages" id="messageArea"></div>
    <div id="scrollUpBtn" class="scroll-button top" onclick="scrollToTop()">↑</div>
    <div id="scrollDownBtn" class="scroll-button bottom" onclick="scrollToBottom()">↓</div>
  </div>
</div>

<!-- Sabit mesaj kutusu container'ın DIŞINDA -->
<div class="send-box" id="sendBox">
  <input type="text" id="messageInput" placeholder="Mesaj yaz...">
  <button class="send-btn" id="sendBtn">Gönder</button>
</div>
    </div>
 </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, updateDoc, deleteDoc,
  collection, query, orderBy, limitToLast, endBefore, limit,
  addDoc, getDocs, onSnapshot, arrayUnion, setDoc, Timestamp
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getMessaging } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-messaging.js";

const firebaseConfig = {
  apiKey: "AIzaSyADPBpJhZ9UKR1NFC42bqEqgKHyLaWunIQ",
  authDomain: "economentor-8ddc4.firebaseapp.com",
  projectId: "economentor-8ddc4",
  storageBucket: "economentor-8ddc4.firebasestorage.app",
  messagingSenderId: "835370350520",
  appId: "1:835370350520:web:d9bb275eb4b7502997814d",
  measurementId: "G-FS3FMPYVPD"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const messaging = getMessaging(app);

let currentUser = null;
let selectedFriendId = null;
let firstVisible = null;
let isLoading = false;
let unsubMessages = null;
const loadedMessageIds = new Set();
let lang = localStorage.getItem("lang") || "tr";

const t = {
  tr: {
    pageTitle: "Mesajlar", placeholder: "Mesaj yaz...", send: "Gönder",
    home: "Ana Sayfa", turkish: "🇹🇷 Türkçe", english: "🇬🇧 English",
    sentAt: "Gönderildi", you: "Sen"
  },
};

function updateTexts() {
  document.getElementById("pageTitle").innerText = t[lang].pageTitle;
  document.getElementById("messageInput").placeholder = t[lang].placeholder;
  document.querySelector(".send-btn").innerText = t[lang].send;
  document.getElementById("homeBtn").innerText = t[lang].home;

  document.querySelectorAll(".message").forEach(msg => {
    const isYou = msg.classList.contains("you");
    const ts = msg.dataset.timestamp;
    const sender = isYou ? t[lang].you : msg.dataset.senderName || "";
    msg.querySelector(".sender-label").innerText = sender;
    msg.querySelector(".timestamp").innerText = `${t[lang].sentAt}: ${formatTimestamp(ts)}`;
  });
}

function setLang(l) {
  lang = l;
  localStorage.setItem("lang", lang);
  updateTexts();
}
window.setLang = setLang;

function formatTimestamp(ts) {
  const d = new Date(Number(ts));
  return `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
}

function getConversationId(uid1, uid2) {
  return [uid1, uid2].sort().join("_");
}
  
onAuthStateChanged(auth, user => {
  if (!user) return location.href = "index.html";
  currentUser = user;
  setLang(lang);

  // 💡 Chat listesi yüklendikten sonra watcher kur
  loadChatList(user.uid).then(() => {
    setupGlobalMessageWatcher(user.uid);
  });
});

async function loadChatList(uid) {
  const usersSnap = await getDocs(collection(db, "users"));
  const list = document.getElementById("chatItems");
  list.innerHTML = "";

  const allItems = [];

const leftSpacer = document.createElement("div");
leftSpacer.style.minWidth = "10px";
leftSpacer.style.height = "1px";
leftSpacer.style.flexShrink = "0";
leftSpacer.className = "chat-start-spacer"; // varsa mobilde stil için
  
  for (const docSnap of usersSnap.docs) {
    const userId = docSnap.id;
    if (userId === uid) continue;

    const username = docSnap.data().username || "Bilinmeyen";
    const convoId = getConversationId(uid, userId);
    const messagesCol = collection(db, "conversations", convoId, "messages");

    const lastMsgSnap = await getDocs(query(messagesCol, orderBy("timestamp", "desc"), limit(1)));

list.appendChild(leftSpacer);
    
    let lastMsg = "", hasNew = false;
    if (!lastMsgSnap.empty) {
      const msg = lastMsgSnap.docs[0].data();
      lastMsg = msg.text || "";
      hasNew = !msg.seenBy?.includes(uid);
    }

    const div = document.createElement("div");
    div.className = "chat-item";
    div.innerHTML = `<strong>${username}</strong><div class="last-message">${lastMsg}</div>`;

    if (hasNew) {
      const notif = document.createElement("div");
      notif.className = "notification";
      div.appendChild(notif);
    }

    div.onclick = () => openChat(userId, div);

    allItems.push({ element: div, hasNew, username: username.toLowerCase() });
  }
  
  allItems.sort((a, b) => {
    if (a.hasNew && !b.hasNew) return -1;
    if (!a.hasNew && b.hasNew) return 1;
    return a.username.localeCompare(b.username);
  });
  
  allItems.forEach(item => list.appendChild(item.element));

  scrollChatListToStart();
  
  filterChatList();

  if (window.innerWidth <= 770) {
  setTimeout(() => {
    const chatItemsDiv = document.getElementById("chatItems");
    if (chatItemsDiv) {
      chatItemsDiv.scrollLeft = 0; // Sıfırla
    }
  }, 300); // DOM otursun diye küçük gecikme
}
}

async function openChat(fid, el) {
  selectedFriendId = fid;
  const area = document.getElementById("messageArea");
  area.innerHTML = ""; // Clear message area

  loadedMessageIds.clear(); // Clear loaded message IDs
  firstVisible = null; // Reset first visible message

  if (unsubMessages) unsubMessages(); // Unsubscribe from previous messages

  // Remove the active class from other chats
  document.querySelectorAll(".chat-item").forEach(i => i.classList.remove("active"));
  const notif = el.querySelector(".notification");
  if (notif) notif.remove(); // Remove notification in the UI
  el.classList.add("active");

  const convoId = getConversationId(currentUser.uid, fid);
  const messagesCol = collection(db, "conversations", convoId, "messages");

  // Fetch all messages (latest ones first)
  const snap = await getDocs(query(messagesCol, orderBy("timestamp", "desc")));
  const messages = [];
  snap.forEach(doc => messages.push({ id: doc.id, ...doc.data() }));

  // Add messages to the chat window
  for (const msg of messages.reverse()) {
    const div = await buildMessageDiv(msg);
    area.appendChild(div);
    loadedMessageIds.add(msg.id); // Add message ID to the set
  }

  firstVisible = snap.docs[0]; // Set the first visible message

  // Scroll to the bottom of the page
  area.lastElementChild?.scrollIntoView({ behavior: "smooth" });

  setupLoadMoreButton(messagesCol);  // Setup "Load Older Messages" button

  // Mark messages as seen by the current user
  for (const msg of messages) {
    if (!msg.seenBy?.includes(currentUser.uid)) {
      await updateDoc(doc(db, "conversations", convoId, "messages", msg.id), {
        seenBy: arrayUnion(currentUser.uid) // Add current user to seenBy
      });
    }
  }
  
unsubMessages = onSnapshot(query(messagesCol, orderBy("timestamp", "asc")), async (snapshot) => {
  snapshot.docChanges().forEach(async (change) => {
    const msg = { id: change.doc.id, ...change.doc.data() };

    const isFromMe = msg.sender === currentUser.uid;
    const isFromFriend = msg.sender === selectedFriendId;
    const senderId = isFromMe ? selectedFriendId : msg.sender;
    const senderDoc = await getDoc(doc(db, "users", senderId));
    const senderName = senderDoc.exists() ? senderDoc.data().username : "Bilinmeyen";

    // 🔹 Yeni mesaj eklendiyse
    if (change.type === "added" && !loadedMessageIds.has(msg.id)) {
      loadedMessageIds.add(msg.id);
      const div = await buildMessageDiv(msg);
      document.getElementById("messageArea").appendChild(div);

    if (window.innerWidth <= 770) {
      setTimeout(() => {
        const chatList = document.querySelector(".chatItems");
        if (chatList) {
          chatList.scrollTo({ left: 0, behavior: "smooth" });
        }
      }, 100); // DOM güncellenene kadar 100ms bekle
    }

      if (isFromMe || isFromFriend) {
        setTimeout(() => {
          scrollToBottom();
        }, 100);
            if (window.innerWidth <= 770) {
      setTimeout(() => {
        const chatList = document.querySelector(".chatItems");
      }, 100); // DOM güncellenene kadar 100ms bekle
    }
      }

const chatItems = document.querySelectorAll(".chat-item");
chatItems.forEach(item => {
  const nameEl = item.querySelector("strong");
  if (nameEl && nameEl.innerText === senderName) {
    const preview = item.querySelector(".last-message");
    if (preview) preview.innerText = msg.text;
    item.parentNode.prepend(item); // 🔼 En üste al
  }
});
      
    if (!msg.seenBy?.includes(currentUser.uid)) {
        await updateDoc(doc(db, "conversations", convoId, "messages", msg.id), {
          seenBy: arrayUnion(currentUser.uid)
        });
      }
    }

    // ✏️ Mesaj düzenlendiyse
if (change.type === "modified") {
  const updatedMsg = change.doc.data();
  const msgDiv = document.querySelector(`.message[data-id="${msg.id}"]`);
  if (msgDiv) {
    msgDiv.querySelector(".msg-text").innerText = updatedMsg.text;

    // GÖRÜLDÜ durumu için güncelleme
    if (updatedMsg.sender === currentUser.uid) {
      let seenDiv = msgDiv.querySelector(".seen-status");

      if (!seenDiv) {
        seenDiv = document.createElement("div");
        seenDiv.classList.add("seen-status");
        seenDiv.setAttribute("data-msgid", updatedMsg.id);
        seenDiv.innerText = lang === "tr" ? "Görüldü" : "Seen";
        msgDiv.appendChild(seenDiv);
      }

      if (updatedMsg.seenBy?.includes(selectedFriendId)) {
        seenDiv.classList.remove("pending");
        seenDiv.classList.add("active");
      } else {
        seenDiv.classList.remove("active");
        seenDiv.classList.add("pending");
      }
    }
  }

  // Chat list "önizleme" güncellemesi
  const chatItems = document.querySelectorAll(".chat-item");
  chatItems.forEach(item => {
    const nameEl = item.querySelector("strong");
    if (nameEl && nameEl.innerText === senderName) {
      const preview = item.querySelector(".last-message");
      if (preview) preview.innerText = updatedMsg.text;
    }
  });
}

    // 🗑️ Mesaj silindiyse
    if (change.type === "removed") {
      const msgDiv = document.querySelector(`.message[data-id="${msg.id}"]`);
      if (msgDiv) msgDiv.remove();

      try {
        const convoId = getConversationId(currentUser.uid, senderId);
        const messagesCol = collection(db, "conversations", convoId, "messages");

        const lastSnap = await getDocs(query(messagesCol, orderBy("timestamp", "desc"), limit(1)));
        const lastText = lastSnap.empty ? "" : lastSnap.docs[0].data().text;

        const chatItems = document.querySelectorAll(".chat-item");
        chatItems.forEach(item => {
          const nameEl = item.querySelector("strong");
          if (nameEl && nameEl.innerText === senderName) {
            const preview = item.querySelector(".last-message");
            if (preview) preview.innerText = lastText;
            item.parentNode.prepend(item); // Silindikten sonra da üste al
          }
        });
      } catch (e) {
        console.warn("Chat list güncellemesi (removed) başarısız:", e);
      }
    }  
    scrollToBottom
  });
});

if (window.innerWidth <= 770) {
  scrollToFirstChatItem();
}
  
function setupLoadMoreButton(messagesCol) {
  const loadBtn = document.getElementById("loadMoreBtn");
  if (!loadBtn || !firstVisible) return;

  loadBtn.onclick = async () => {
    if (isLoading) return;  // Eğer yükleniyorsa, tekrar yükleme yapma
    isLoading = true;

    const area = document.getElementById("messageArea");
    const prevScrollHeight = area.scrollHeight;

    // Eski mesajları çekiyoruz (50 mesaj birden)
    const snap = await getDocs(query(
      messagesCol,
      orderBy("timestamp", "desc"),  // Zaman sırasına göre en eskiyi önce alıyoruz
      endBefore(firstVisible),  // Son görülen mesajdan önceki mesajları alıyoruz
      limitToLast(50)  // 50 tane eski mesaj alıyoruz
    ));

    const messages = [];
    snap.forEach(doc => {
      if (!loadedMessageIds.has(doc.id)) {
        messages.push({ id: doc.id, ...doc.data() });
        loadedMessageIds.add(doc.id);
      }
    });

    // Eski mesajları ters sıralıyoruz
    for (const msg of messages.reverse()) {
      const div = await buildMessageDiv(msg);
      area.insertBefore(div, loadBtn.nextSibling);  // Yüklenen eski mesajları butonun üstüne ekliyoruz
    }

    if (!snap.empty) {
      firstVisible = snap.docs[0];  // Eski mesajların ilkini ayarladık
    } else {
      loadBtn.style.display = "none";  // Eğer eski mesaj yoksa, butonu gizliyoruz
    }

    const newScrollHeight = area.scrollHeight;
    area.scrollTop = newScrollHeight - prevScrollHeight;  // Scroll pozisyonunu koruyoruz
    isLoading = false;

    // Eski mesajlar yüklendikten sonra en alta kaydırıyoruz
    area.lastElementChild?.scrollIntoView({ behavior: "smooth" });
    };
  }
}

async function buildMessageDiv(msg) {
  const div = document.createElement("div");
  const isMine = msg.sender === currentUser.uid;
  div.className = "message" + (isMine ? " you" : "");
  div.setAttribute("data-id", msg.id);
  div.setAttribute("data-timestamp", msg.timestamp);

  let senderName = t[lang].you;
  if (!isMine) {
    const senderDoc = await getDoc(doc(db, "users", msg.sender));
    senderName = senderDoc.exists() ? senderDoc.data().username : "Bilinmeyen";
  }

  div.setAttribute("data-sender-name", senderName);

  const timeStr = `${t[lang].sentAt}: ${formatTimestamp(msg.timestamp)}`;

  // Görüldü kontrolü
let seenClass = "";
let seenLabel = "";
if (msg.sender === currentUser.uid) {
  seenLabel = lang === "tr" ? "Görüldü" : "Seen";

  if (msg.seenBy?.includes(selectedFriendId)) {
    seenClass = "active";
  } else {
    seenClass = "pending";
  }
}

div.innerHTML = `
  <div class="sender-label">${senderName}</div>
  <div class="msg-text">${msg.text}</div>
  <div class="timestamp">${t[lang].sentAt}: ${formatTimestamp(msg.timestamp)}</div>
  ${seenLabel ? `<div class="seen-status ${seenClass}" data-msgid="${msg.id}">${seenLabel}</div>` : ""}
`;

  // ✏️ ve 🗑️ butonları (sen yazdıysan)
  if (isMine) {
    const convoId = getConversationId(currentUser.uid, selectedFriendId);
    const editBtn = document.createElement("button");
    editBtn.textContent = "✏️";
    editBtn.style.marginLeft = "6px";
    editBtn.onclick = () => {
      const input = document.getElementById("messageInput");
      input.value = msg.text;
      input.focus();
      input.dataset.editing = msg.id;
    };

    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "🗑️";
    deleteBtn.style.marginLeft = "6px";
    deleteBtn.onclick = async () => {
      if (confirm("Mesaj silinsin mi?")) {
        await deleteDoc(doc(db, "conversations", convoId, "messages", msg.id));
        const divToRemove = document.querySelector(`.message[data-id="${msg.id}"]`);
        if (divToRemove) divToRemove.remove();
      }
    };

    div.appendChild(editBtn);
    div.appendChild(deleteBtn);
  }

  return div;
}

document.getElementById("sendBtn").addEventListener("click", async () => {
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  const editId = input.dataset.editing;
  if (!text || !selectedFriendId || !currentUser) return;

  input.value = "";
  const convoId = getConversationId(currentUser.uid, selectedFriendId);
  const msgCol = collection(db, "conversations", convoId, "messages");

  if (editId) {
    await updateDoc(doc(msgCol, editId), { text });
    const msgDiv = document.querySelector(`.message[data-id="${editId}"]`);
    if (msgDiv) msgDiv.querySelector(".msg-text").innerText = text;
    delete input.dataset.editing;
  } else {
    const msg = {
      sender: currentUser.uid,
      text,
      timestamp: Date.now(),
      seenBy: []
    };
    await addDoc(msgCol, msg);
    await updateDoc(doc(db, "users", selectedFriendId), {
      inboxHasNew: true
    });

const currentUserDoc = await getDoc(doc(db, "users", currentUser.uid));
const senderName = currentUserDoc.exists() ? currentUserDoc.data().username : "Bir kullanıcı";

await createNotificationForUser(
  selectedFriendId,
  `"${senderName}" size "${text}" içerikli bir mesaj gönderdi.`,
  null
);

    scrollToBottom();

    // 🔔 Push bildirim gönder
    try {
      const recipientDoc = await getDoc(doc(db, "users", selectedFriendId));
      let notificationTitle = "\"Economentor\" 📩 Yeni mesaj!";
      if (recipientDoc.exists() && recipientDoc.data().role === "admin") {
        notificationTitle = "\"Economentor(Admin)\" 📩 Yeni mesaj!";
      }

      await fetch("https://fcm-server-1-3uer.onrender.com/sendToUid", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          uid: selectedFriendId,
          title: notificationTitle,
          body: text,
          url: "https://economentor.netlify.app"
        })
      });
    } catch (err) {
      console.error("Bildirim gönderme hatası:", err);
    }
  }
});
  
window.goHome = () => location.href = "anasayfa.html";

async function createNotificationForUser(uid, message, postId = null) {
  const docId = `${uid}_${Date.now()}`;
  await setDoc(doc(db, "notifications", docId), {
    to: uid,
    message: message,
    postId: postId,
    timestamp: Timestamp.now(),
    read: false
  });
}

function filterChatList() {
  const searchInput = window.innerWidth <= 768
    ? document.getElementById("mobileSearchBar")
    : document.getElementById("searchBar");

  const searchQuery = searchInput.value.toLowerCase();
  const chatItems = document.querySelectorAll(".chat-item");

  chatItems.forEach(item => {
    const name = item.querySelector("strong").textContent.toLowerCase();
    item.style.display = name.includes(searchQuery) ? "block" : "none";
  });
}
document.addEventListener("DOMContentLoaded", function() {
  document.getElementById("searchBar").addEventListener("input", filterChatList);
  document.getElementById("mobileSearchBar").addEventListener("input", filterChatList);
});

  document.getElementById("messageInput").addEventListener("keydown", function(event) {
  if (event.key === "Enter" && !event.shiftKey) { // Sadece Enter (Shift+Enter değil)
    event.preventDefault(); // Enter'ın satır atlamasını engelle
    document.getElementById("sendBtn").click();  // Gönder butonuna tıkla
  }
});

    if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/firebase-messaging-sw.js')
      .then(reg => console.log("✅ firebase-messaging-sw.js yüklendi:", reg))
      .catch(err => console.error("❌ SW kaydedilemedi:", err));
  }

function scrollToBottom() {
  const area = document.getElementById("messageArea");
  if (area) {
    area.scrollTop = area.scrollHeight;
  }
}

  function scrollToTop() {
  const area = document.getElementById("messageArea");
  if (area) area.scrollTop = 0;
}

window.scrollToBottom = scrollToBottom;
window.scrollToTop = scrollToTop;

function updateScrollButtons() {
  const area = document.getElementById("messageArea");
  const upBtn = document.getElementById("scrollUpBtn");
  const downBtn = document.getElementById("scrollDownBtn");

  if (!area) return;

  const scrollTop = area.scrollTop;
  const scrollHeight = area.scrollHeight;
  const clientHeight = area.clientHeight;

  const atTop = scrollTop <= 0;
  const atBottom = scrollTop + clientHeight >= scrollHeight - 2; // küçük tolerans

  if (atTop) {
    upBtn.style.display = "none";
    downBtn.style.display = "flex";
  } else if (atBottom) {
    upBtn.style.display = "flex";
    downBtn.style.display = "none";
  } else {
    upBtn.style.display = "flex";
    downBtn.style.display = "flex";
  }
}

document.addEventListener("DOMContentLoaded", () => {
  if (window.innerWidth <= 770) {
    const chatItems = document.getElementById("chatItems");
    if (chatItems) {
      // Mobilde sohbet sayfası açıldığında en başa kaydır
      chatItems.scrollTo({ left: 0, behavior: "auto" });

      // Kullanıcının sola kaymasını engelle
      chatItems.addEventListener("scroll", () => {
        if (chatItems.scrollLeft < 0) {
          chatItems.scrollLeft = 0;
        }
      });
    }
  }
});

window.addEventListener("load", () => {
  document.body.style.overflow = "hidden"; // sadece mobil için bile olsa garanti
  document.documentElement.scrollTop = 0;
  document.body.scrollTop = 0;
});

async function setupGlobalMessageWatcher(myUid) {
  const usersSnap = await getDocs(collection(db, "users"));
  usersSnap.forEach(otherUserDoc => {
    const otherUid = otherUserDoc.id;
    if (otherUid === myUid) return;

    const convoId = getConversationId(myUid, otherUid);
    const messagesCol = collection(db, "conversations", convoId, "messages");

    onSnapshot(
      query(messagesCol, orderBy("timestamp", "desc"), limit(1)),
      snapshot => {
        if (snapshot.empty) return;
        const msgDoc = snapshot.docs[0];
        const msg = msgDoc.data();
        const chatItems = document.querySelectorAll(".chat-item");

        // Sohbet zaten chatlist'te varsa
        chatItems.forEach(item => {
          const name = item.querySelector("strong")?.innerText?.trim().toLowerCase();
          if (name === (otherUserDoc.data().username || "").toLowerCase()) {
            const preview = item.querySelector(".last-message");
            if (preview) preview.innerText = msg.text || "";

            // Eğer mesaj henüz görülmediyse ve mesaj karşıdan geldiyse
if (
  !msg.seenBy?.includes(myUid) &&
  msg.sender !== myUid &&
  selectedFriendId !== otherUid
) {
  if (!item.querySelector(".notification")) {
    const notif = document.createElement("div");
    notif.className = "notification";
    item.appendChild(notif);
  }
}

            // Chatlist'te en üste taşı
            const chatList = document.getElementById("chatItems");
            if (chatList && item.parentNode === chatList) {
              chatList.prepend(item);
            }
              const chatItems = document.getElementById("chatItems");
            if (window.innerWidth <= 770 && chatItems) {
               chatItems.scrollTo({ left: 0, behavior: "smooth" });
  }
          }
        });
      }
    );
  });
}
  
document.addEventListener("DOMContentLoaded", () => {
  const chatItems = document.getElementById("chatItems");
  if (window.innerWidth <= 770 && chatItems) {
    chatItems.scrollTo({ left: 0, behavior: "smooth" });
  }
});

function scrollChatListToStart() {
  const chatItems = document.getElementById("chatItems");
  if (window.innerWidth <= 770 && chatItems) {
    requestAnimationFrame(() => {
      chatItems.scrollLeft = 0;
    });
  }
}

function lockChatListLeftScroll() {
  const chatItems = document.getElementById("chatItems");
  if (window.innerWidth <= 770 && chatItems) {
    chatItems.scrollLeft = 0;

    // Sol kayma olursa anında geri çek
    chatItems.addEventListener("scroll", () => {
      if (chatItems.scrollLeft < 0) {
        chatItems.scrollLeft = 0;
      }
    });
  }
}

document.addEventListener("DOMContentLoaded", lockChatListLeftScroll);
window.addEventListener("resize", lockChatListLeftScroll);

function preventLeftScroll() {
  const el = document.getElementById("chatItems");
  if (!el) return;

  function fixScroll() {
    if (el.scrollLeft < 0) {
      el.scrollLeft = 0;
    }
    requestAnimationFrame(fixScroll); // Her karede kontrol et
  }

  requestAnimationFrame(fixScroll); // Başlat
}

// Sayfa yüklendiğinde başlat
document.addEventListener("DOMContentLoaded", () => {
  if (window.innerWidth <= 770) {
    preventLeftScroll();
  }
});

function lockScrollLeftOnMobile() {
  const chatItemsDiv = document.getElementById("chatItems");
  if (window.innerWidth <= 770 && chatItemsDiv) {
    chatItemsDiv.scrollLeft = Math.max(chatItemsDiv.scrollLeft, 0);
  }
};

function scrollToFirstChatItem() {
  const chatItems = document.getElementById("chatItems");
  if (!chatItems) return;

  // DOM içeriği değiştiği için birden fazla frame bekletiyoruz
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      chatItems.scrollLeft = 0;
    });
  });
}

  if (window.innerWidth <= 770) {
  setTimeout(() => {
    const chatItemsDiv = document.getElementById("chatItems");
    if (chatItemsDiv) {
      chatItemsDiv.scrollLeft = 0; // Sıfırla
    }
  }, 1000); // DOM otursun diye küçük gecikme
}
  
/* window.scrollToBottom = scrollToBottom; */
  
</script>
<script type="module" src="auth-guard.js"></script>
</body>
</html>

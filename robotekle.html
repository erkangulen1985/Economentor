<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Economentor | Robot Ekle</title>
  <link rel="icon" href="image1.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* Buradaki stil, mevcut sitenizin stiline uyumlu olacak ÅŸekilde ayarlanabilir */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f1f1f1;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      color: #333;
    }

    header {
      background-color: #4CAF50;
      color: white;
      padding: 20px 0;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    header h1 {
      margin: 0;
      font-size: 36px;
      letter-spacing: 2px;
    }

    /* Navigation Menu */
    nav {
      display: flex;
      justify-content: space-around;
      background-color: #333;
      padding: 15px 0;
    }

    nav a {
      text-decoration: none;
      color: white;
      font-weight: bold;
      font-size: 16px;
      padding: 10px;
      transition: background 0.3s ease;
    }

    nav a:hover {
      background-color: #4CAF50;
    }

    .content {
      flex-grow: 1;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .upload-section {
      width: 80%;
      background-color: #fff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .upload-section input[type="file"],
    .upload-section input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .upload-section button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }

    .upload-section button:hover {
      background-color: #45a049;
    }

    .user-list {
      margin-top: 20px;
      max-height: 200px;
      overflow-y: auto;
    }

    .user-list li {
      padding: 8px;
      border: 1px solid #ccc;
      margin-bottom: 8px;
      cursor: pointer;
      background-color: #f9f9f9;
      border-radius: 5px;
    }

    .user-list li:hover {
      background-color: #e0e0e0;
    }

    .footer {
      background-color: #333;
      color: white;
      padding: 10px;
      text-align: center;
      position: relative;
      bottom: 0;
      width: 100%;
    }

    .shared-files {
      margin-top: 40px;
      width: 80%;
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .shared-files h3 {
      text-align: center;
      margin-bottom: 20px;
    }

    .shared-files ul {
      list-style-type: none;
      padding: 0;
    }

    .shared-files li {
      padding: 10px;
      border: 1px solid #ddd;
      margin-bottom: 10px;
      background-color: #f9f9f9;
      border-radius: 5px;
    }

    .shared-files li button {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 14px;
      border-radius: 5px;
      float: right;
    }

    .shared-files li button:hover {
      background-color: #c0392b;
    }

#publishedRobotsList li {
  padding: 10px;
  border: 1px solid #ddd;
  margin-bottom: 10px;
  background-color: #f9f9f9;
  border-radius: 5px;
  position: relative;
}

#publishedRobotsList li button {
  background-color: #4CAF50;
  color: white;
  border: none;
  padding: 5px 10px;
  cursor: pointer;
  font-size: 14px;
  border-radius: 5px;
  margin-left: 5px;
}

#publishedRobotsList li button.delete {
  background-color: #e74c3c;
}

#publishedRobotsList li button.delete:hover {
  background-color: #c0392b;
}

#publishedRobotsList li button:hover {
  opacity: 0.9;
}

/* AÃ§Ä±klama satÄ±r atlamalarÄ±nÄ± koru */
#publishedRobotsList li .description {
  white-space: pre-wrap;
  margin-top: 5px;
  display: block;
}

#publishedRobotsDropdown {
  border: 1px solid #ccc;
  max-height: 150px;
  overflow-y: auto;
  overflow-x: hidden;
  position: absolute;
  background: #fff;
  width: 100%;
  top: 100%; /* inputâ€™un altÄ±na yerleÅŸtir */
  left: 0;
  margin-top: 4px;
  padding-left: 0;
  list-style: none;
  display: none;
  z-index: 999;
  box-sizing: border-box;
  font-size: 14px;
  white-space: nowrap;
}

#publishedRobotsDropdown li {
  padding: 8px;
  cursor: pointer;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.shared-files, .upload-section {
  margin-bottom: 100px; /* Ä°ki blok arasÄ±na boÅŸluk koyar */
}

  </style>
</head>
<body>

  <header>
    <h1>Economentor | Robot Ekle</h1>
  </header>

  <nav>
    <a href="adminpanel.html">YÃ¶netici Paneli</a> <!-- YÃ¶netici Paneline YÃ¶nlendiren Link -->
    <a href="robot.html">Robot SayfasÄ±</a>
  </nav>

<div class="content">

<!-- Robot YayÄ±nla BÃ¶lÃ¼mÃ¼ -->
<div class="upload-section" style="width: 100%; max-width: 700px;">
  <h2>Robot YayÄ±nla</h2>
  <input type="text" id="robotTitle" placeholder="Robot AdÄ±" />
  <textarea id="robotDescription" placeholder="AÃ§Ä±klama" rows="4" style="width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
  <button id="publishRobotButton">YayÄ±nla</button>
</div>

  <!-- YayÄ±nlanmÄ±ÅŸ Robotlar -->
  <div class="shared-files">
    <h3>YayÄ±nlanmÄ±ÅŸ Robotlar</h3>
    <ul id="publishedRobotsList"></ul>
  </div>

<!-- Yeni Robot PaylaÅŸ BÃ¶lÃ¼mÃ¼ -->
<div class="upload-section" style="width: 100%; max-width: 700px;">
  <h2>Yeni Robot PaylaÅŸ</h2>
  <input type="file" id="fileUpload" accept=".rar" />

  <!-- YayÄ±nlanmÄ±ÅŸ Robot SeÃ§iniz Dropdown -->
  <div style="position: relative; width: 100%; margin-bottom: 15px;">
    <input type="text" id="fileNameInput" placeholder="YayÄ±nlanmÄ±ÅŸ Robot SeÃ§iniz" autocomplete="off" style="width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ddd; border-radius: 5px;" />
    <ul id="publishedRobotsDropdown" style="
        border: 1px solid #ccc;
        max-height: 150px;
        overflow-y: auto;
        overflow-x: hidden;
        position: absolute;
        background: #fff;
        width: 100%;
        top: 100%;
        left: 0;
        margin-top: 4px;
        padding-left: 0;
        list-style: none;
        display: none;
        z-index: 999;
        box-sizing: border-box;
        font-size: 14px;
        white-space: nowrap;
      ">
    </ul>
  </div>

  <!-- KullanÄ±cÄ± Arama -->
  <input type="text" id="searchInput" placeholder="KullanÄ±cÄ± AdÄ± Ara" style="margin-bottom: 10px;" />
  <ul id="userList" class="user-list"></ul>

  <!-- SeÃ§ilen KullanÄ±cÄ±lar -->
  <h3>SeÃ§ilen KullanÄ±cÄ±lar:</h3>
  <ul id="selectedUserList"></ul>

  <button id="uploadButton">PaylaÅŸ</button>
</div>

  <!-- GeÃ§miÅŸte PaylaÅŸÄ±lan Robot DosyalarÄ± -->
  <div class="shared-files">
    <h3>GeÃ§miÅŸte PaylaÅŸÄ±lan Robot DosyalarÄ±</h3>
    <ul id="sharedFilesList"></ul>
  </div>

</div>

<!-- Footer -->
<div class="footer">
  <p>Â© 2025 Economentor. TÃ¼m HaklarÄ± SaklÄ±dÄ±r.</p>
</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.10.0/+esm';
    import { getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyADPBpJhZ9UKR1NFC42bqEqgKHyLaWunIQ",
      authDomain: "economentor-8ddc4.firebaseapp.com",
      projectId: "economentor-8ddc4",
      storageBucket: "economentor-8ddc4.firebasestorage.app",
      messagingSenderId: "835370350520",
      appId: "1:835370350520:web:d9bb275eb4b7502997814d",
      measurementId: "G-FS3FMPYVPD"
    };

    const supabaseUrl = "https://rvwsvhgihatxxhnbmouw.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2d3N2aGdpaGF0eHhobmJtb3V3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2MTYxNTAsImV4cCI6MjA1OTE5MjE1MH0.91XCg6CE4WfI6Rr4K5vIOJB5-fi5QW8SZ98LngMLJMI";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const supabase = createClient(supabaseUrl, supabaseKey);
    const auth = getAuth();

    // Arama ve kullanÄ±cÄ± listeleme
    document.getElementById("searchInput").addEventListener("input", searchUsers);

import { getAuth } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

// Dosya yÃ¼kleme iÅŸlemi
document.getElementById("uploadButton").addEventListener("click", async function() {
  const file = document.getElementById("fileUpload").files[0];
  const customName = document.getElementById("fileNameInput").value.trim();
  
  if (!customName) {
    alert("LÃ¼tfen bir dosya adÄ± girin.");
    return;
  }

  if (!file) {
    alert("LÃ¼tfen bir dosya seÃ§in.");
    return;
  }

  if (selectedUsers.length === 0) {
    alert("LÃ¼tfen en az bir kullanÄ±cÄ± seÃ§in.");
    return;
  }

  try {
    const fileName = `${Date.now()}-${file.name}`;
    const safeFileName = sanitizeFilename(fileName);
    const { error } = await supabase.storage.from('robotlar').upload(safeFileName, file);

    if (error) throw new Error(`Dosya yÃ¼klenemedi: ${error.message}`);

    const fileUrl = `${supabaseUrl}/storage/v1/object/public/robotlar/${safeFileName}`;
    const sharedUserIds = selectedUsers.map(user => user.uid);

    const fileData = {
      fileUrl: fileUrl,
      sharedWith: sharedUserIds,
      timestamp: new Date(),
      robotId: selectedRobot?.id || null,
      robotTitle: selectedRobot?.title || null
    };

    if (!fileData.fileUrl || sharedUserIds.length === 0 || !selectedRobot) {
      throw new Error("Eksik veri: Dosya URL'si, kullanÄ±cÄ± veya robot bilgisi eksik.");
    }

    await setDoc(doc(db, "uploadedFiles", safeFileName), fileData);

    // ðŸ”” Bildirim gÃ¶nder
    const auth = getAuth();
    const currentUser = auth.currentUser;
    const sharerName = currentUser?.displayName || "Bir kullanÄ±cÄ±";

    await notifyUsersOfRobotShare(sharedUserIds, fileData.robotTitle, sharerName);

    alert("Dosya baÅŸarÄ±yla yÃ¼klendi ve kullanÄ±cÄ±lara bildirildi!");
    loadSharedFiles();
    clearUploadForm();

  } catch (err) {
    console.error("Dosya yÃ¼klenirken hata:", err);
    alert(`Dosya yÃ¼klenirken bir hata oluÅŸtu: ${err.message}`);
  }
});

// ðŸ“¢ Bildirim gÃ¶nderme fonksiyonu
async function notifyUsersOfRobotShare(userIds, robotTitle, sharerName) {
  for (const uid of userIds) {
    const notificationMessage = `${sharerName} sizinle "${robotTitle}" adlÄ± robotu paylaÅŸtÄ±.`;

    const docId = `${uid}_${Date.now()}`;
    await setDoc(doc(db, "notifications", docId), {
      to: uid,
      message: notificationMessage,
      timestamp: Timestamp.now(),
      read: false
    });

    // FCM token kontrolÃ¼
    try {
      const tokenDoc = await getDoc(doc(db, "fcmTokens", uid));
      if (tokenDoc.exists()) {
        await fetch("https://fcm-server-1-3uer.onrender.com/sendToUid", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            uid: uid,
            title: "\"Economentor\" ðŸ¤– Yeni Robot PaylaÅŸÄ±mÄ±",
            body: notificationMessage,
            url: "https://economentor.netlify.app"
          })
        });
      } else {
        console.log(`FCM token yok (UID: ${uid}) â€” sadece Firestore bildirimi gÃ¶nderildi.`);
      }
    } catch (error) {
      console.error(`FCM bildirimi hatasÄ± (UID: ${uid}):`, error);
    }
  }
}

async function searchUsers() {
  const searchTerm = document.getElementById("searchInput").value.toLowerCase();
  const usersSnap = await getDocs(collection(db, "users"));
  const userList = document.getElementById("userList");

  userList.innerHTML = ""; // Eski listeyi temizliyoruz

  usersSnap.forEach((userDoc) => {
    const userData = userDoc.data();  // KullanÄ±cÄ± verisini alÄ±yoruz
    const fullName = userData.fullName || '';  // KullanÄ±cÄ± ismini alÄ±yoruz

    console.log("userData:", userData);  // Burada userData'yÄ± log'layarak kontrol ediyoruz
    console.log("userData.uid:", userData.uid);  // Burada userData.uid'yi loglayarak kontrol ediyoruz

    // KullanÄ±cÄ± adÄ± ile arama yapÄ±yoruz
    if (fullName.toLowerCase().includes(searchTerm)) {
      const listItem = document.createElement("li");
      listItem.textContent = fullName;  // KullanÄ±cÄ± adÄ±nÄ± listeye ekliyoruz
      listItem.onclick = () => selectUser(userDoc.id); // KullanÄ±cÄ±yÄ± uid'si ile seÃ§iyoruz
      userList.appendChild(listItem); // Listeye ekliyoruz
    }
  });
}

let selectedUsers = [];

async function selectUser(uid) {
  console.log("SeÃ§ilen KullanÄ±cÄ± ID:", uid);  // KullanÄ±cÄ± ID'sini log'la

  const userRef = doc(db, "users", uid);
  try {
    const docSnap = await getDoc(userRef);
    if (docSnap.exists()) {
      const userData = docSnap.data();
      userData.uid = uid;  // UID'yi ekle!

      if (!selectedUsers.find(u => u.uid === uid)) {
        selectedUsers.push(userData);
        console.log("SeÃ§ilen KullanÄ±cÄ±lar (UID):", selectedUsers.map(user => user.uid));
        updateSelectedUserList();
      }
    } else {
      console.log("KullanÄ±cÄ± bulunamadÄ±!");
    }
  } catch (error) {
    console.error("KullanÄ±cÄ± bilgisi alÄ±nÄ±rken hata:", error);
  }
}

// Function to update the list of selected users on the UI
function updateSelectedUserList() {
  const selectedUserList = document.getElementById("selectedUserList");
  selectedUserList.innerHTML = "";  // Clear the current list

  selectedUsers.forEach((user, index) => {
    const listItem = document.createElement("li");
    listItem.textContent = user.fullName;
    const removeButton = document.createElement("button");
    removeButton.textContent = "Sil";
    removeButton.onclick = () => removeUser(index);  // Remove user from selected list
    listItem.appendChild(removeButton);
    selectedUserList.appendChild(listItem);
  });
}

// Function to remove a user from the selected list
function removeUser(index) {
  selectedUsers.splice(index, 1);  // Remove the user at the given index
  updateSelectedUserList();  // Update the displayed list
}

// sanitizeFilename fonksiyonu
function sanitizeFilename(filename) {
  return filename
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "") // aksanlÄ± harfleri kaldÄ±r
    .replace(/[^a-zA-Z0-9_.-]/g, ""); // sadece geÃ§erli karakterler
}

async function loadSharedFiles() {
  const sharedFilesList = document.getElementById("sharedFilesList");
  sharedFilesList.innerHTML = ""; // Ã–nceki listeleri temizle

  const sharedFilesSnap = await getDocs(collection(db, "uploadedFiles"));
  for (const docSnap of sharedFilesSnap.docs) {
    const sharedFile = docSnap.data();

    const listItem = document.createElement("li");
    const fileUrl = sharedFile.fileUrl;
    const sharedWith = sharedFile.sharedWith || [];

    // UID'leri isimlere dÃ¶nÃ¼ÅŸtÃ¼r
    const userNames = [];
    for (const uid of sharedWith) {
      const userRef = doc(db, "users", uid);
      const userSnap = await getDoc(userRef);
      if (userSnap.exists()) {
        const data = userSnap.data();
        userNames.push(data.fullName || uid);
      } else {
        userNames.push(uid);
      }
    }

    listItem.innerHTML = `
      <strong>Dosya:</strong> <a href="${fileUrl}" target="_blank">${fileUrl.split("/").pop()}</a><br>
      <strong>Robot AdÄ±:</strong> ${sharedFile.robotTitle || "Belirtilmedi"}<br>
      <strong>PaylaÅŸÄ±lan KullanÄ±cÄ±lar:</strong> ${userNames.join(", ")}
    `;

    const removeButton = document.createElement("button");
    removeButton.textContent = "Sil";
    removeButton.onclick = () => deleteSharedFile(docSnap.id);
    listItem.appendChild(removeButton);

    sharedFilesList.appendChild(listItem);
  }
}

async function deleteSharedFile(fileId) {
  try {
    // Firestore'dan dosya verisini al
    const docRef = doc(db, "uploadedFiles", fileId);
    const docSnap = await getDoc(docRef);

    if (docSnap.exists()) {
      const fileData = docSnap.data();
      const fileUrl = fileData.fileUrl;

      // Supabase Storage iÃ§in dosya adÄ±nÄ± Ã§Ä±kar (URL'deki son parÃ§a)
      const fileName = fileUrl.split('/').pop();

      // Supabase'den sil
      const { error: supabaseError } = await supabase.storage.from('robotlar').remove([fileName]);
      if (supabaseError) {
        console.warn("Supabase dosya silme hatasÄ±:", supabaseError.message);
      }

      // Firestore'dan sil
      await deleteDoc(docRef);

      // Listeyi yenile
      loadSharedFiles();

    } else {
      console.log("Silinecek dosya Firestore'da bulunamadÄ±.");
    }
  } catch (error) {
    console.error("Dosya silinirken hata oluÅŸtu:", error);
  }
}

document.getElementById("publishRobotButton").addEventListener("click", async () => {
  const title = document.getElementById("robotTitle").value.trim();
  const description = document.getElementById("robotDescription").value.trim();

  if (!title || !description) {
    alert("LÃ¼tfen robot adÄ± ve aÃ§Ä±klama girin.");
    return;
  }

  const robotData = {
    title,
    description,
    timestamp: new Date()
  };

  try {
    const id = `robot-${Date.now()}`;
await setDoc(doc(db, "publishedRobots", id), robotData);
alert("Robot baÅŸarÄ±yla yayÄ±nlandÄ±!");
document.getElementById("robotTitle").value = "";
document.getElementById("robotDescription").value = "";
loadPublishedRobots();
fetchPublishedRobotsForSelection()
  } catch (error) {
    console.error("Robot yayÄ±nlama hatasÄ±:", error);
    alert("YayÄ±nlanÄ±rken bir hata oluÅŸtu: " + error.message);
  }
});

let editingId = null; // DÃ¼zenlenen robotun id'si
    
async function loadPublishedRobots() {
  const list = document.getElementById("publishedRobotsList");
  list.innerHTML = "";

  try {
    const snap = await getDocs(collection(db, "publishedRobots"));
    const robots = snap.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));

    // Tarihe gÃ¶re sÄ±ralama (Firestore Timestamp veya Date objesi olabilir)
    robots.sort((a, b) => {
      const aTime = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : new Date(a.timestamp).getTime();
      const bTime = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : new Date(b.timestamp).getTime();
      return bTime - aTime;
    });

    for (const robot of robots) {
      const li = document.createElement("li");

      if (editingId === robot.id) {
        // DÃ¼zenleme modu
        li.innerHTML = `
          <input id="editTitle" type="text" value="${robot.title}" style="width: 100%; padding: 5px; font-size: 16px;" />
          <textarea id="editDescription" style="width: 100%; padding: 5px; font-size: 16px; margin-top: 5px;" rows="4">${robot.description}</textarea>
          <button id="saveBtn">Kaydet</button>
          <button id="cancelBtn">Ä°ptal</button>
        `;

        li.querySelector("#saveBtn").onclick = async () => {
          const newTitle = li.querySelector("#editTitle").value.trim();
          const newDesc = li.querySelector("#editDescription").value.trim();
          if (!newTitle || !newDesc) {
            alert("LÃ¼tfen baÅŸlÄ±k ve aÃ§Ä±klama girin.");
            return;
          }
          try {
            await updateDoc(doc(db, "publishedRobots", robot.id), {
              title: newTitle,
              description: newDesc,
              timestamp: new Date()
            });
            editingId = null;
            loadPublishedRobots();
            fetchPublishedRobotsForSelection()
          } catch (error) {
            console.error("Robot gÃ¼ncellenirken hata:", error);
            alert("GÃ¼ncellenirken hata oluÅŸtu.");
          }
        };

        li.querySelector("#cancelBtn").onclick = () => {
          editingId = null;
          loadPublishedRobots();
          fetchPublishedRobotsForSelection()
        };

      } else {
        // Normal gÃ¶sterim
        li.innerHTML = `
          <strong>${robot.title}</strong>
          <span class="description">${robot.description.replace(/\n/g, "<br>")}</span>
          <button class="editBtn">DÃ¼zenle</button>
          <button class="delete deleteBtn">Sil</button>
        `;
        li.querySelector(".editBtn").onclick = () => {
          editingId = robot.id;
          loadPublishedRobots();
          fetchPublishedRobotsForSelection()
        };
        li.querySelector(".deleteBtn").onclick = async () => {
          if (confirm("Bu robotu silmek istediÄŸinizden emin misiniz?")) {
            try {
              await deleteDoc(doc(db, "publishedRobots", robot.id));
              loadPublishedRobots();
              fetchPublishedRobotsForSelection()
            } catch (error) {
              console.error("Robot silinirken hata:", error);
              alert("Silme iÅŸlemi sÄ±rasÄ±nda hata oluÅŸtu.");
            }
          }
        };
      }

      list.appendChild(li);
    }
  } catch (error) {
    console.error("YayÄ±nlanmÄ±ÅŸ robotlar yÃ¼klenirken hata:", error);
  }
}

let publishedRobots = []; // YayÄ±nlanmÄ±ÅŸ robotlarÄ± burada tutacaÄŸÄ±z
let selectedRobot = null; // SeÃ§ilen robot objesi

async function fetchPublishedRobotsForSelection() {
  try {
    const snap = await getDocs(collection(db, "publishedRobots"));
    publishedRobots = snap.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));

    // BasitÃ§e input altÄ±na listeyi gÃ¶sterelim
    showPublishedRobotOptions();
  } catch (error) {
    console.error("YayÄ±nlanmÄ±ÅŸ robotlar alÄ±nÄ±rken hata:", error);
  }
}

const fileNameInput = document.getElementById("fileNameInput");
const publishedRobotsDropdown = document.getElementById("publishedRobotsDropdown");

function showPublishedRobotOptions() {
  publishedRobotsDropdown.innerHTML = "";
  if (publishedRobots.length === 0) {
    publishedRobotsDropdown.style.display = "none";
    return;
  }

  publishedRobots.forEach(robot => {
    const li = document.createElement("li");
    li.textContent = robot.title;
    li.style.padding = "8px";
    li.style.cursor = "pointer";

    li.onclick = () => {
      fileNameInput.value = robot.title;
      selectedRobot = robot; // SeÃ§ilen robotu kaydet
      publishedRobotsDropdown.style.display = "none";
    };

    publishedRobotsDropdown.appendChild(li);
  });

  publishedRobotsDropdown.style.display = "block";
}

fileNameInput.addEventListener("click", () => {
  if (publishedRobots.length > 0) {
    showPublishedRobotOptions();
  }
});

fileNameInput.addEventListener("input", () => {
  const val = fileNameInput.value.toLowerCase();
  publishedRobotsDropdown.innerHTML = "";
  const filtered = publishedRobots.filter(r => r.title.toLowerCase().includes(val));

  if (filtered.length === 0) {
    publishedRobotsDropdown.style.display = "none";
    selectedRobot = null;
    return;
  }

  filtered.forEach(robot => {
    const li = document.createElement("li");
    li.textContent = robot.title;
    li.style.padding = "8px";
    li.style.cursor = "pointer";
    li.onclick = () => {
      fileNameInput.value = robot.title;
      selectedRobot = robot;
      publishedRobotsDropdown.style.display = "none";
    };
    publishedRobotsDropdown.appendChild(li);
  });

  publishedRobotsDropdown.style.display = "block";
});
;

document.addEventListener("click", (event) => {
  // EÄŸer tÄ±klama fileNameInput veya dropdown dÄ±ÅŸÄ±nda ise dropdown kapansÄ±n
  if (
    event.target !== fileNameInput &&
    !publishedRobotsDropdown.contains(event.target)
  ) {
    publishedRobotsDropdown.style.display = "none";
  }
});
    
// Sayfa yÃ¼klendiÄŸinde geÃ§miÅŸte paylaÅŸÄ±lan dosyalarÄ± yÃ¼kleyelim
loadPublishedRobots()
fetchPublishedRobotsForSelection();
loadSharedFiles();
searchUsers();
    
</script>
<script type="module" src="auth-guard.js"></script>
</body>
</html>

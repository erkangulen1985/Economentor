<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economentor | Admin Paneli</title>
    <link rel="icon" href="image1.png">
    <style>
        /* Stil tanımlamaları */
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #222;
            color: white;
        }
        .sidebar {
            width: 250px;
            position: fixed;
            height: 100%;
            background-color: #0f0f0f;
            padding-top: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.7);
        }
        .sidebar h2 {
            text-align: center;
            font-size: 24px;
            color: #fff;
            margin-bottom: 30px;
        }
        .sidebar a {
            display: block;
            color: #ccc;
            padding: 15px;
            text-decoration: none;
            font-size: 18px;
            margin: 5px 0;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        .sidebar a:hover {
            background-color: #4CAF50;
            color: white;
        }
        .main-content {
            margin-left: 250px;
            padding: 30px;
            height: 100vh;
            background-color: #121212;
            overflow-y: auto;
        }
        .title {
            font-size: 30px;
            margin-bottom: 20px;
        }
        .content-container {
            background-color: #333;
            padding: 20px;
            border-radius: 10px;
        }
        .logout-button {
            background-color: red;
        }
        .logout-button:hover {
            background-color: #ff4d4d;
        }
        textarea {
            width: 100%;
            height: 120px;
            border-radius: 8px;
            padding: 10px;
            font-size: 16px;
            resize: none;
        }
        .button {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .announcement, .feedback, .user-card {
            background-color: #444;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            position: relative;
        }
        .announcement button, .feedback button, .user-card button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: red;
            border: none;
            border-radius: 4px;
            color: white;
            padding: 5px 10px;
            cursor: pointer;
        }
        .search-bar {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            border: none;
            font-size: 16px;
        }
        canvas {
            background-color: #fff;
            border-radius: 8px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Admin Paneli</h2>
        <a href="#" onclick="showContent('kul-is')">Kullanıcı ve İstatistik Yönetimi</a>
        <a href="#" onclick="showContent('duyuru-admin')">Duyuru Düzenle</a>
        <a href="#" onclick="showContent('hakkinda-admin')">Hakkında Düzenle</a>
        <a href="#" onclick="showContent('dil-sik')">Dilek ve Şikayetler</a>
        <a href="paylasim.html">Paylaşımlar</a>
        <a href="mesaj.html">Mesajlar</a>
        <a href="profil.html">Profil</a>
        <a href="anasayfa.html">Anasayfa</a>
        <a href="index.html" class="logout-button">Çıkış</a>
    </div>

    <div class="main-content">
        <div class="content-container">
            <h2 class="title">Hoşgeldiniz, <span id="adminUsername">Yönetici</span>!</h2>
            <div id="dynamicContent"></div>
        </div>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, getDocs, deleteDoc,
  collection, Timestamp
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import Chart from "https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js";

const firebaseConfig = {
  apiKey: "AIzaSyADPBpJhZ9UKR1NFC42bqEqgKHyLaWunIQ",
  authDomain: "economentor-8ddc4.firebaseapp.com",
  projectId: "economentor-8ddc4",
  storageBucket: "economentor-8ddc4.appspot.com",
  messagingSenderId: "835370350520",
  appId: "1:835370350520:web:d9bb275eb4b7502997814d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Kullanıcı silme
window.deleteUserFromAdmin = async (uid) => {
  if (!confirm("Bu kullanıcıyı silmek istediğinize emin misiniz?")) return;
  try {
    await deleteDoc(doc(db, "users", uid));
    alert("Kullanıcı silindi!");
    showContent('kul-is');
  } catch (err) {
    alert("Hata oluştu: " + err.message);
  }
};

// Kullanıcıları ve istatistikleri getir
window.showContent = async (section) => {
  const container = document.getElementById("dynamicContent");
  container.innerHTML = "";

  if (section === "kul-is") {
    container.innerHTML = `
      <h3>Kullanıcı ve İstatistik Yönetimi</h3>
      <input type="text" id="searchUser" placeholder="Kullanıcı adı veya isim ara..." style="width:100%;padding:10px;border-radius:6px;margin-bottom:20px;">
      <div id="stats" style="margin-bottom:40px;"></div>
      <canvas id="userGrowthChart" height="100"></canvas>
      <canvas id="likeChart" height="100"></canvas>
      <canvas id="dislikeChart" height="100"></canvas>
      <canvas id="commentChart" height="100"></canvas>
      <h4 style="margin-top:40px;">Tüm Kullanıcılar</h4>
      <div id="userList"></div>
    `;

    // Sayılar
    const analizSnap = await getDocs(collection(db, "analizler"));
    const photoSnap = await getDocs(collection(db, "photos"));
    const feedbackSnap = await getDocs(collection(db, "feedback"));
    const userSnap = await getDocs(collection(db, "users"));

    const statsDiv = document.getElementById("stats");
    statsDiv.innerHTML = `
      <p>Toplam Analiz: <b>${analizSnap.size}</b></p>
      <p>Toplam Fotoğraf: <b>${photoSnap.size}</b></p>
      <p>Toplam Dilek/Şikayet: <b>${feedbackSnap.size}</b></p>
      <p>Toplam Kullanıcı: <b>${userSnap.size}</b></p>
    `;

    // Grafik verileri
    const growthData = {};
    const likeData = {};
    const dislikeData = {};
    const commentData = {};

    analizSnap.forEach(doc => {
      const data = doc.data();
      const date = data.timestamp?.toDate().toLocaleDateString("tr-TR") || "Bilinmiyor";
      growthData[date] = (growthData[date] || 0) + 1;
      likeData[date] = (likeData[date] || 0) + (data.likes || 0);
      dislikeData[date] = (dislikeData[date] || 0) + (data.dislikes || 0);
      commentData[date] = (commentData[date] || 0) + (data.comments?.length || 0);
    });

    const labels = Object.keys(growthData);

    const makeChart = (ctxId, label, dataObj, color) => {
      new Chart(document.getElementById(ctxId), {
        type: "line",
        data: {
          labels,
          datasets: [{
            label,
            data: labels.map(l => dataObj[l]),
            borderColor: color,
            fill: false
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true }
          }
        }
      });
    };

    makeChart("userGrowthChart", "Analiz Yükleme Grafiği", growthData, "#4CAF50");
    makeChart("likeChart", "Beğeniler", likeData, "#2980b9");
    makeChart("dislikeChart", "Beğenmeme", dislikeData, "#e74c3c");
    makeChart("commentChart", "Yorumlar", commentData, "#f1c40f");

    // Kullanıcı listesi
    const list = document.getElementById("userList");
    const renderUsers = (docs) => {
      list.innerHTML = "";
      docs.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.style = "background:#444;margin:8px 0;padding:10px;border-radius:6px;";
        div.innerHTML = `
          <p><b>Kullanıcı Adı:</b> ${data.username || "Yok"} | <b>Ad Soyad:</b> ${data.fullName || "Yok"}</p>
          <p><b>UID:</b> ${docSnap.id}</p>
          <button onclick="deleteUserFromAdmin('${docSnap.id}')" style="background:red;color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;">Sil</button>
        `;
        list.appendChild(div);
      });
    };

    renderUsers(userSnap.docs);

    document.getElementById("searchUser").addEventListener("input", (e) => {
      const keyword = e.target.value.toLowerCase();
      const filtered = userSnap.docs.filter(d =>
        (d.data().username || "").toLowerCase().includes(keyword) ||
        (d.data().fullName || "").toLowerCase().includes(keyword)
      );
      renderUsers(filtered);
    });
  }
};
</script>
